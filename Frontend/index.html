<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI Lernkarten & Quiz App (Mehrfachauswahl)</title> <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to top, #f3e8ff, #e9d5ff);
        }

        /* Flashcard styles */
        .flashcard-container { perspective: 1000px; min-height: 250px; position: relative; transition: box-shadow 0.3s ease-in-out; }
        .flashcard-container.feedback-known { box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.6); }
        .flashcard-container.feedback-repeat { box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.6); }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); font-family: 'Inter', sans-serif; text-align: center; border: 1px solid rgba(0,0,0,0.05); position: relative; }
        .flashcard-front { background-color: #ffffff; color: #1f2937; }
        .flashcard-back { background-color: #f5f3ff; color: #5b21b6; transform: rotateY(180deg); }
        .status-icon { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; color: white; z-index: 10; }
        .status-icon-known { background-color: rgba(34, 197, 94, 0.8); }
        .status-icon-repeat { background-color: rgba(239, 68, 68, 0.8); }

        /* Button styles */
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button:not(:disabled) { transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out; }
        button:not(:disabled):hover { transform: scale(1.03); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        button:not(:disabled):active { transform: scale(0.98); }

        /* Tab styles */
        .tab-button { padding: 0.6rem 1.2rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease-in-out; border-bottom: 3px solid transparent; margin-bottom: -1px; font-weight: 500; }
        .tab-button.active { background-color: transparent; color: #4f46e5; border-bottom-color: #4f46e5; }
        .tab-button:not(.active) { background-color: transparent; color: #6b7280; border-color: transparent; }
        .tab-button:not(.active):hover { background-color: #f3f4f6; color: #374151; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Error message */
        .error-message { color: #991b1b; background-color: #fee2e2; border: 1px solid #fca5a5; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-top: 1rem; text-align: center; font-size: 0.875rem; font-weight: 500; }
        /* Loader */
        .loader { border: 4px solid #e5e7eb; border-top: 4px solid #4f46e5; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 8px auto 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Quiz Area Styles */
        #quiz-area { border: 1px dashed #cbd5e1; padding: 1.5rem; border-radius: 0.75rem; margin-top: 1.5rem; background-color: #fafafa; }
        .quiz-question { font-size: 1.125rem; font-weight: 500; margin-bottom: 1rem; color: #1f2937; }
        /* Updated for checkboxes */
        .quiz-options label {
            display: flex; /* Align checkbox and text */
            align-items: center; /* Vertically align */
            background-color: white;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .quiz-options label:hover { background-color: #f9fafb; border-color: #a5b4fc; }
        .quiz-options input[type="checkbox"] {
            margin-right: 0.75rem; /* Increased spacing */
            width: 1rem; height: 1rem; /* Explicit size */
            accent-color: #4f46e5; /* Indigo */
            cursor: pointer;
        }
        /* Style for checked state (optional visual feedback) */
        .quiz-options input[type="checkbox"]:checked + span {
             /* font-weight: 500; */ /* Example: make text medium */
             /* color: #4f46e5; */ /* Example: change text color */
        }
        .quiz-options label.correct {
             border-color: #22c55e; /* green-500 */
             background-color: #f0fdf4; /* green-50 */
        }
         .quiz-options label.incorrect {
             border-color: #ef4444; /* red-500 */
             background-color: #fef2f2; /* red-50 */
         }
          .quiz-options label.missed {
             border-color: #f97316; /* orange-500 */
             /* background-color: #fff7ed; */ /* orange-50 */
             /* Add a subtle indicator for missed correct answers */
             position: relative;
         }
         .quiz-options label.missed::after {
             content: '✓';
             position: absolute;
             right: 1rem;
             color: #16a34a; /* green-600 */
             font-weight: bold;
         }


        .quiz-feedback { margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; font-weight: 500; }
        .feedback-correct { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .feedback-incorrect { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .quiz-results { margin-top: 1.5rem; padding: 1rem; background-color: #eef2ff; border: 1px solid #c7d2fe; border-radius: 0.5rem; text-align: center; }

    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-white to-sky-50 min-h-screen flex flex-col items-center justify-center p-4 md:p-8">

    <div class="w-full max-w-3xl bg-white p-6 md:p-10 rounded-xl shadow-xl">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-8">
             KI Lernkarten & Quiz App ✨
        </h1>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-1 md:space-x-2 justify-center" aria-label="Tabs">
                <button id="tab-text" class="tab-button active" data-tab="text-input-area">Text</button>
                <button id="tab-file" class="tab-button" data-tab="file-input-area">Datei</button>
                <button id="tab-url" class="tab-button" data-tab="url-input-area">URL</button>
            </nav>
        </div>

        <div class="mb-8">
            <div id="text-input-area" class="tab-content active">
                <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">Füge hier deinen Text ein:</label>
                <textarea id="text-input" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Gib hier den Text ein, aus dem Lernkarten generiert werden sollen..."></textarea>
            </div>
            <div id="file-input-area" class="tab-content">
                <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">Lade eine Datei hoch (.txt, .pdf, .docx):</label>
                <input type="file" id="file-input" accept=".txt,.pdf,.docx,text/plain,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="w-full p-3 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer transition duration-150">
                 <p class="text-xs text-gray-500 mt-1">Hinweis: Die Verarbeitung der Datei erfolgt im Backend.</p>
            </div>
            <div id="url-input-area" class="tab-content">
                <label for="url-input" class="block text-sm font-medium text-gray-700 mb-2">Gib eine Webseiten-URL ein:</label>
                <input type="url" id="url-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="https://beispiel.de/artikel">
                <p class="text-xs text-gray-500 mt-1">Hinweis: Das Abrufen und Verarbeiten der URL erfolgt im Backend.</p>
            </div>
        </div>

        <div class="mb-8 flex flex-col sm:flex-row items-center justify-center sm:space-x-6 space-y-4 sm:space-y-0">
             <div class="flex items-center space-x-3">
                 <label for="max-cards-input" class="text-sm font-medium text-gray-700">Max. Lernkarten:</label>
                 <input type="number" id="max-cards-input" value="10" min="3" max="25" class="w-20 p-2 border border-gray-300 rounded-lg shadow-sm text-center focus:ring-indigo-500 focus:border-indigo-500">
             </div>
             <div class="flex items-center space-x-3">
                 <label for="num-questions-input" class="text-sm font-medium text-gray-700">Anzahl Quizfragen:</label>
                 <input type="number" id="num-questions-input" value="5" min="3" max="15" class="w-20 p-2 border border-gray-300 rounded-lg shadow-sm text-center focus:ring-indigo-500 focus:border-indigo-500">
             </div>
        </div>

        <div class="text-center mb-8 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="generate-button" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out text-base">
                Lernkarten generieren
            </button>
            <button id="generate-quiz-button" class="w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out text-base">
                Quiz generieren
            </button>
        </div>
         <div id="loading-indicator" style="display: none;" class="text-center mb-4">
             <div class="loader inline-block"></div>
             <p id="loading-text" class="text-sm text-indigo-600 mt-2">Generiere...</p>
         </div>
         <p id="ai-notice" class="text-xs text-gray-500 text-center mt-2 font-medium mb-4" style="display: none;">Hinweis: Die KI-Generierung erfolgt im Backend.</p>
         <div id="error-area" class="mt-4" style="display: none;">
             <p id="error-message" class="error-message"></p>
         </div>


        <div id="flashcard-area" class="mb-6" style="display: none;">
            <p class="text-center text-sm text-gray-500 mb-3">Klicke auf die Karte, um sie umzudrehen.</p>
            <div id="flashcard-container" class="flashcard-container w-full h-64 md:h-72 mx-auto mb-5 rounded-xl">
                <div id="flashcard" class="flashcard">
                    <div class="flashcard-face flashcard-front text-lg md:text-xl">
                        <div id="card-status-icon-front" class="status-icon" style="display: none;"></div>
                        <span id="card-front-text">Frage wird hier angezeigt</span>
                    </div>
                    <div class="flashcard-face flashcard-back text-lg md:text-xl">
                        <div id="card-status-icon-back" class="status-icon" style="display: none;"></div>
                        <span id="card-back-text">Antwort wird hier angezeigt</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center mb-5">
                <button id="prev-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out disabled:bg-gray-100 disabled:text-gray-400" disabled>Zurück</button>
                <button id="shuffle-button" class="shuffle-button bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out flex items-center disabled:bg-purple-200 disabled:text-purple-400" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v3a2 2 0 01-2 2H5a2 2 0 01-2-2v-3a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0l3 3m-3-3l-3 3" /></svg>
                    Mischen
                </button>
                <span id="card-counter" class="text-base font-medium text-gray-700">Karte 0 / 0</span>
                <button id="next-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out disabled:bg-gray-100 disabled:text-gray-400" disabled>Weiter</button>
            </div>
            <div id="progress-buttons" class="flex justify-center space-x-5 mt-5">
                 <button id="repeat-button" class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-3 px-6 rounded-lg shadow-sm transition duration-150 ease-in-out flex items-center disabled:bg-red-50 disabled:text-red-300" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                     Nochmal
                 </button>
                 <button id="known-button" class="bg-green-100 hover:bg-green-200 text-green-700 font-semibold py-3 px-6 rounded-lg shadow-sm transition duration-150 ease-in-out flex items-center disabled:bg-green-50 disabled:text-green-300" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                     Wusste ich
                 </button>
            </div>
            <div class="text-center mt-6">
                <button id="reset-progress-button" class="text-xs text-gray-500 hover:text-gray-700 hover:underline disabled:text-gray-300" disabled>
                    Lernfortschritt zurücksetzen
                </button>
            </div>
        </div>

        <div id="quiz-area" class="mb-6" style="display: none;">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Quiz</h2>
            <div id="quiz-content">
                 <p class="text-center text-gray-500">Quiz wird geladen...</p>
            </div>
            <div id="quiz-feedback" class="quiz-feedback mt-4" style="display: none;"> {/* Added margin-top */}
                </div>
            <div class="text-center mt-6">
                <button id="quiz-submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-150 ease-in-out" disabled> {/* Start disabled */}
                    Antwort prüfen
                </button>
            </div>
             <div id="quiz-results-area" class="quiz-results" style="display: none;">
                 </div>
        </div>
        <div id="no-cards-message" class="text-center text-gray-500 mt-4" style="display: none;">
            Keine Lernkarten zum Anzeigen vorhanden.
        </div>
         <div id="no-quiz-message" class="text-center text-gray-500 mt-4" style="display: none;">
            Kein Quiz zum Anzeigen vorhanden.
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {

        // --- DOM Elements ---
        const textInput = document.getElementById('text-input');
        const fileInput = document.getElementById('file-input');
        const urlInput = document.getElementById('url-input');
        const generateButton = document.getElementById('generate-button');
        const generateQuizButton = document.getElementById('generate-quiz-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        const aiNotice = document.getElementById('ai-notice');
        const errorArea = document.getElementById('error-area');
        const errorMessage = document.getElementById('error-message');
        // Flashcard Elements
        const flashcardArea = document.getElementById('flashcard-area');
        const flashcardContainer = document.getElementById('flashcard-container');
        const flashcard = document.getElementById('flashcard');
        const cardFrontText = document.getElementById('card-front-text');
        const cardBackText = document.getElementById('card-back-text');
        const cardStatusIconFront = document.getElementById('card-status-icon-front');
        const cardStatusIconBack = document.getElementById('card-status-icon-back');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const cardCounter = document.getElementById('card-counter');
        const noCardsMessage = document.getElementById('no-cards-message');
        const progressButtonsContainer = document.getElementById('progress-buttons');
        const knownButton = document.getElementById('known-button');
        const repeatButton = document.getElementById('repeat-button');
        const shuffleButton = document.getElementById('shuffle-button');
        const resetProgressButton = document.getElementById('reset-progress-button');
        const maxCardsInput = document.getElementById('max-cards-input');
        // Quiz Elements
        const numQuestionsInput = document.getElementById('num-questions-input');
        const quizArea = document.getElementById('quiz-area');
        const quizContent = document.getElementById('quiz-content');
        const quizFeedback = document.getElementById('quiz-feedback');
        const quizSubmitButton = document.getElementById('quiz-submit-button');
        const quizResultsArea = document.getElementById('quiz-results-area');
        const noQuizMessage = document.getElementById('no-quiz-message');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');


        // --- Configuration ---
        const BACKEND_URL_FLASHCARDS = '/api/generate';
        const BACKEND_URL_QUIZ = '/api/generate-quiz';
        const LOCAL_STORAGE_KEY_PREFIX = 'flashcardProgress_';
        let currentSourceIdentifier = '';

        // --- State ---
        let cards = [];
        let quizQuestions = [];
        let currentCardIndex = 0;
        let currentQuizIndex = 0;
        let quizScore = 0;
        let currentQuizSelectedIndices = new Set(); // Use a Set for multiple selections
        let quizAnswerChecked = false;
        let isCardFlipped = false;
        let activeTab = 'text';
        let cardFeedbackTimeout = null;
        let currentMode = 'flashcards';

        // --- Functions ---

        function displayError(message) { /* ... */ errorMessage.textContent = message; errorArea.style.display = 'block'; loadingIndicator.style.display = 'none'; flashcardArea.style.display = 'none'; quizArea.style.display = 'none'; noCardsMessage.style.display = 'none'; noQuizMessage.style.display = 'none'; }
        function clearError() { /* ... */ errorMessage.textContent = ''; errorArea.style.display = 'none'; }
        function switchTab(tabId) { /* ... */ activeTab = tabId.split('-')[0]; if (tabButtons && tabButtons.length > 0) { tabButtons.forEach(button => button.classList.toggle('active', button.dataset.tab === tabId)); } if (tabContents && tabContents.length > 0) { tabContents.forEach(content => content.classList.toggle('active', content.id === tabId)); } clearError(); hideFlashcards(); hideQuiz(); }
        function clearCardFeedbackIndicator() { /* ... */ if (cardFeedbackTimeout) clearTimeout(cardFeedbackTimeout); flashcardContainer.classList.remove('feedback-known', 'feedback-repeat'); }
        function simpleHash(str) { /* ... */ let hash = 0; for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; } return Math.abs(hash).toString(36); }
        function loadProgress() { /* ... */ if (!currentSourceIdentifier) return; const key = LOCAL_STORAGE_KEY_PREFIX + currentSourceIdentifier; const savedProgress = localStorage.getItem(key); if (savedProgress) { const progressData = JSON.parse(savedProgress); cards.forEach(card => { if (progressData[card.id]) { card.status = progressData[card.id]; } }); } }
        function saveProgress() { /* ... */ if (!currentSourceIdentifier || cards.length === 0) return; const key = LOCAL_STORAGE_KEY_PREFIX + currentSourceIdentifier; const progressToSave = {}; cards.forEach(card => { if (card.status) { progressToSave[card.id] = card.status; } }); if (Object.keys(progressToSave).length > 0) { localStorage.setItem(key, JSON.stringify(progressToSave)); } else { localStorage.removeItem(key); } }
        function updatePersistentStatusIcon(card) { /* ... */ [cardStatusIconFront, cardStatusIconBack].forEach(iconEl => { iconEl.style.display = 'none'; iconEl.className = 'status-icon'; if (card && card.status) { iconEl.style.display = 'flex'; if (card.status === 'known') { iconEl.classList.add('status-icon-known'); iconEl.textContent = '✓'; } else if (card.status === 'repeat') { iconEl.classList.add('status-icon-repeat'); iconEl.textContent = '✕'; } } }); }

        // --- Flashcard Specific Functions ---
        function hideFlashcards() { flashcardArea.style.display = 'none'; noCardsMessage.style.display = 'none'; }
        function displayCard(index = currentCardIndex) { /* ... */ hideQuiz(); clearCardFeedbackIndicator(); if (index < 0 || index >= cards.length) index = 0; currentCardIndex = index; if (cards.length === 0) { hideFlashcards(); noCardsMessage.style.display = 'block'; updatePersistentStatusIcon(null); updateNavigation(); return; } noCardsMessage.style.display = 'none'; flashcardArea.style.display = 'block'; const card = cards[currentCardIndex]; cardFrontText.textContent = card.front; cardBackText.textContent = card.back; updatePersistentStatusIcon(card); if (isCardFlipped) { flashcard.classList.remove('is-flipped'); isCardFlipped = false; } updateNavigation(); }
        function updateNavigation() { /* ... */ const hasCards = cards.length > 0; const hasMultipleCards = cards.length > 1; flashcardArea.style.display = (hasCards && currentMode === 'flashcards') ? 'block' : 'none'; noCardsMessage.style.display = (!hasCards && currentMode === 'flashcards') ? 'block' : 'none'; cardCounter.textContent = `Karte ${hasCards ? currentCardIndex + 1 : 0} / ${cards.length}`; prevButton.disabled = !hasCards || currentCardIndex === 0; nextButton.disabled = !hasCards || currentCardIndex === cards.length - 1; knownButton.disabled = !hasCards; repeatButton.disabled = !hasCards; shuffleButton.disabled = !hasMultipleCards; resetProgressButton.disabled = !hasCards; }
        function flipCard() { /* ... */ if (cards.length === 0) return; isCardFlipped = !isCardFlipped; flashcard.classList.toggle('is-flipped', isCardFlipped); }
        function goToNextCard() { /* ... */ if (currentCardIndex < cards.length - 1) { currentCardIndex++; displayCard(); } else { console.log("End of cards reached."); clearCardFeedbackIndicator(); } }
        function markCardStatus(status) { /* ... */ if (cards.length === 0) return; clearCardFeedbackIndicator(); flashcardContainer.classList.add(status === 'known' ? 'feedback-known' : 'feedback-repeat'); cards[currentCardIndex].status = status; updatePersistentStatusIcon(cards[currentCardIndex]); saveProgress(); cardFeedbackTimeout = setTimeout(() => { clearCardFeedbackIndicator(); goToNextCard(); }, 400); }
        function shuffleCards() { /* ... */ if (cards.length < 2) return; console.log("Shuffling cards..."); for (let i = cards.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [cards[i], cards[j]] = [cards[j], cards[i]]; } console.log("Cards shuffled."); displayCard(0); }
        function resetCurrentProgress() { /* ... */ if (!currentSourceIdentifier || cards.length === 0) return; const key = LOCAL_STORAGE_KEY_PREFIX + currentSourceIdentifier; localStorage.removeItem(key); cards.forEach(card => delete card.status); console.log(`Progress reset for source: ${currentSourceIdentifier}`); displayCard(currentCardIndex); }

        // --- Quiz Specific Functions ---
        function hideQuiz() {
            quizArea.style.display = 'none';
            noQuizMessage.style.display = 'none';
            quizFeedback.style.display = 'none';
            quizResultsArea.style.display = 'none';
        }

        function displayQuizQuestion() {
            hideFlashcards();
            if (quizQuestions.length === 0 || currentQuizIndex >= quizQuestions.length) {
                hideQuiz();
                noQuizMessage.style.display = 'block';
                return;
            }

            noQuizMessage.style.display = 'none';
            quizArea.style.display = 'block';
            quizFeedback.style.display = 'none';
            quizResultsArea.style.display = 'none';
            quizSubmitButton.textContent = 'Antwort prüfen';
            quizAnswerChecked = false;
            currentQuizSelectedIndices.clear(); // Clear previous selections

            const questionData = quizQuestions[currentQuizIndex];
            let optionsHtml = `<div class="quiz-question">${currentQuizIndex + 1}. ${questionData.question}</div>`;
            optionsHtml += '<div class="quiz-options space-y-2">';

            questionData.options.forEach((option, index) => {
                // Use checkboxes instead of radio buttons
                optionsHtml += `
                    <label class="block">
                        <input type="checkbox" name="quizOption_${currentQuizIndex}" value="${index}" onchange="handleOptionChange(this, ${index})">
                        <span>${option}</span>
                    </label>
                `;
            });
            optionsHtml += '</div>';
            quizContent.innerHTML = optionsHtml;
            quizSubmitButton.disabled = true; // Start disabled, enable when at least one option is checked
        }

        // Updated handler for checkbox changes
        function handleOptionChange(checkboxElement, index) {
            if (checkboxElement.checked) {
                currentQuizSelectedIndices.add(index);
            } else {
                currentQuizSelectedIndices.delete(index);
            }
            // Enable submit button only if at least one checkbox is selected
            quizSubmitButton.disabled = currentQuizSelectedIndices.size === 0;
             console.log("Selected indices:", currentQuizSelectedIndices); // Debugging
        }

        // Updated answer checking logic for multiple correct answers
        function checkQuizAnswer() {
            if (currentQuizSelectedIndices.size === 0) return; // Should not happen if button is enabled

            const questionData = quizQuestions[currentQuizIndex];
            // Ensure correctAnswerIndices is always an array
            const correctIndices = new Set(Array.isArray(questionData.correctAnswerIndices) ? questionData.correctAnswerIndices : [questionData.correctAnswerIndex]);
            const selectedIndices = currentQuizSelectedIndices;

            let isFullyCorrect = correctIndices.size === selectedIndices.size &&
                                 [...correctIndices].every(index => selectedIndices.has(index));

            quizFeedback.style.display = 'block';
            quizFeedback.classList.remove('feedback-correct', 'feedback-incorrect');

            // Provide visual feedback on each option
            document.querySelectorAll('.quiz-options label').forEach((label, index) => {
                 const checkbox = label.querySelector('input[type="checkbox"]');
                 checkbox.disabled = true; // Disable after checking
                 label.style.cursor = 'default';
                 label.classList.remove('correct', 'incorrect', 'missed'); // Clear previous feedback classes

                 const isCorrectOption = correctIndices.has(index);
                 const isSelected = selectedIndices.has(index);

                 if (isCorrectOption && isSelected) {
                     label.classList.add('correct'); // Correctly selected
                 } else if (!isCorrectOption && isSelected) {
                     label.classList.add('incorrect'); // Incorrectly selected
                 } else if (isCorrectOption && !isSelected) {
                     label.classList.add('missed'); // Correct answer missed
                 }
            });


            if (isFullyCorrect) {
                quizScore++;
                quizFeedback.textContent = 'Richtig!';
                quizFeedback.classList.add('feedback-correct');
            } else {
                // Construct feedback message listing correct answers
                const correctAnswersText = [...correctIndices].map(i => questionData.options[i]).join(', ');
                quizFeedback.textContent = `Teilweise richtig / Falsch. Korrekte Antwort(en): ${correctAnswersText}`;
                quizFeedback.classList.add('feedback-incorrect');
            }

            quizAnswerChecked = true;
            quizSubmitButton.textContent = (currentQuizIndex < quizQuestions.length - 1) ? 'Nächste Frage' : 'Ergebnis anzeigen';
            quizSubmitButton.disabled = false; // Ensure button is enabled to proceed
        }

        function showQuizResults() {
            hideQuiz();
            quizResultsArea.innerHTML = `
                <h3 class="text-lg font-semibold mb-2">Quiz beendet!</h3>
                <p>Dein Ergebnis: ${quizScore} von ${quizQuestions.length} Fragen richtig beantwortet.</p>
                 <button onclick="restartQuiz()" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow">Quiz neu starten</button>
                 <button onclick="switchToFlashcards()" class="mt-4 ml-2 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow">Zu Lernkarten</button>
            `;
            quizResultsArea.style.display = 'block';
        }

         // New function to restart the quiz
         function restartQuiz() {
             currentQuizIndex = 0;
             quizScore = 0;
             quizAnswerChecked = false;
             currentQuizSelectedIndices.clear();
             displayQuizQuestion();
         }

         // New function to switch back to flashcard mode
         function switchToFlashcards() {
             currentMode = 'flashcards';
             hideQuiz();
             // Display the first flashcard if available, otherwise show the 'no cards' message
             if (cards.length > 0) {
                 displayCard(0);
             } else {
                 hideFlashcards(); // Ensure card area is hidden
                 noCardsMessage.style.display = 'block'; // Show message if no cards were ever generated
             }
         }


        function handleQuizSubmit() {
            if (!quizAnswerChecked) {
                checkQuizAnswer();
            } else {
                // Move to next question or show results
                currentQuizIndex++;
                if (currentQuizIndex < quizQuestions.length) {
                    displayQuizQuestion();
                } else {
                    showQuizResults();
                }
            }
        }

        async function generateQuiz() {
            clearError();
            hideFlashcards();
            hideQuiz();

            let fetchOptions = { method: 'POST' };
            let requestPayload = {};
            const numQuestions = parseInt(numQuestionsInput.value, 10) || 5;

            if (activeTab === 'text') { /* ... */ const textData = textInput.value; if (!textData.trim()) { displayError("Bitte gib zuerst Text ein."); return; } fetchOptions.headers = { 'Content-Type': 'application/json' }; requestPayload = { inputType: 'text', textData: textData, numQuestions: numQuestions }; fetchOptions.body = JSON.stringify(requestPayload);
            } else if (activeTab === 'file') { /* ... */ const file = fileInput.files[0]; if (!file) { displayError("Bitte wähle zuerst eine Datei aus."); return; } const formData = new FormData(); formData.append('inputType', 'file'); formData.append('inputFile', file); formData.append('numQuestions', numQuestions); fetchOptions.body = formData;
            } else if (activeTab === 'url') { /* ... */ const urlData = urlInput.value; if (!urlData.trim() || !urlData.startsWith('http')) { displayError("Bitte gib zuerst eine gültige URL ein."); return; } fetchOptions.headers = { 'Content-Type': 'application/json' }; requestPayload = { inputType: 'url', urlData: urlData, numQuestions: numQuestions }; fetchOptions.body = JSON.stringify(requestPayload);
            } else { displayError("Unbekannter Eingabe-Tab."); return; }

            loadingText.textContent = 'Generiere Quiz...';
            loadingIndicator.style.display = 'block';
            generateQuizButton.disabled = true;
            generateButton.disabled = true;
            quizQuestions = [];
            currentQuizIndex = 0;
            quizScore = 0;

            console.log(`Sending request to: ${BACKEND_URL_QUIZ}`);
             if (fetchOptions.body instanceof FormData) { console.log('Request FormData includes:'); for (let [key, value] of fetchOptions.body.entries()) { if (value instanceof File) { console.log(`  ${key}: ${value.name}`); } else { console.log(`  ${key}: ${value}`); } } } else { console.log('Request body:', fetchOptions.body); }

            try {
                const response = await fetch(BACKEND_URL_QUIZ, fetchOptions);
                console.log(`Quiz Response status: ${response.status} ${response.statusText}`);
                if (!response.ok) { let errorMsg = `Fehler vom Server (Quiz): ${response.status} ${response.statusText}`; try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) {} throw new Error(errorMsg); }
                const data = await response.json();
                console.log('Quiz Data received:', data);
                if (data.quiz && Array.isArray(data.quiz) && data.quiz.length > 0) {
                    quizQuestions = data.quiz;
                    currentQuizIndex = 0;
                    quizScore = 0;
                    currentMode = 'quiz';
                    displayQuizQuestion();
                } else { quizQuestions = []; displayError("Konnte keine Quizfragen generieren oder die Antwort war leer."); }
            } catch (error) {
                console.error("Fehler beim Generieren des Quiz:", error);
                displayError(`Fehler: ${error.message}. Läuft der Backend-Server?`);
                quizQuestions = [];
                hideQuiz();
            } finally {
                loadingIndicator.style.display = 'none';
                generateQuizButton.disabled = false;
                generateButton.disabled = false;
            }
        }


        // --- Event Listeners ---
        if (tabButtons && tabButtons.length > 0) {
             tabButtons.forEach(button => {
                 button.addEventListener('click', () => { switchTab(button.dataset.tab); });
             });
        } else { console.error("Could not find tab buttons on initialization."); }

        generateButton.addEventListener('click', async () => { /* ... (Flashcard generation logic remains the same) ... */
            clearError(); hideQuiz(); let fetchOptions = { method: 'POST' }; let requestPayload = {}; const maxCards = parseInt(maxCardsInput.value, 10) || 10; let sourceName = `text_input_temp`;
            if (activeTab === 'text') { const textData = textInput.value; if (!textData.trim()) { displayError("Bitte gib Text ein."); return; } fetchOptions.headers = { 'Content-Type': 'application/json' }; requestPayload = { inputType: 'text', textData: textData, maxCards: maxCards }; fetchOptions.body = JSON.stringify(requestPayload); sourceName = `text_${simpleHash(textData.substring(0, 200))}`; }
            else if (activeTab === 'file') { const file = fileInput.files[0]; if (!file) { displayError("Bitte wähle eine Datei aus."); return; } const formData = new FormData(); formData.append('inputType', 'file'); formData.append('inputFile', file); formData.append('maxCards', maxCards); fetchOptions.body = formData; sourceName = `file_${file.name}_${file.size}`; }
            else if (activeTab === 'url') { const urlData = urlInput.value; if (!urlData.trim() || !urlData.startsWith('http')) { displayError("Bitte gib eine gültige URL ein."); return; } fetchOptions.headers = { 'Content-Type': 'application/json' }; requestPayload = { inputType: 'url', urlData: urlData, maxCards: maxCards }; fetchOptions.body = JSON.stringify(requestPayload); sourceName = `url_${simpleHash(urlData)}`; }
            currentSourceIdentifier = sourceName; loadingText.textContent = 'Generiere Lernkarten...'; loadingIndicator.style.display = 'block'; aiNotice.style.display = 'none'; generateButton.disabled = true; generateQuizButton.disabled = true; cards = []; currentCardIndex = 0;
            console.log(`Sending request to: ${BACKEND_URL_FLASHCARDS} for source: ${currentSourceIdentifier}`); if (fetchOptions.body instanceof FormData) { console.log('Request FormData includes:'); for (let [key, value] of fetchOptions.body.entries()) { if (value instanceof File) { console.log(`  ${key}: ${value.name}`); } else { console.log(`  ${key}: ${value}`); } } } else { console.log('Request body:', fetchOptions.body); }
            try {
                const response = await fetch(BACKEND_URL_FLASHCARDS, fetchOptions); console.log(`Flashcard Response status: ${response.status} ${response.statusText}`); if (!response.ok) { let errorMsg = `Fehler vom Server: ${response.status} ${response.statusText}`; try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) {} throw new Error(errorMsg); }
                const data = await response.json(); console.log('Flashcard Data received:', data); if (data.flashcards && Array.isArray(data.flashcards) && data.flashcards.length > 0) { cards = data.flashcards.map((card, index) => ({ ...card, id: `card_${index}` })); loadProgress(); currentCardIndex = 0; isCardFlipped = false; currentMode = 'flashcards'; displayCard(); aiNotice.style.display = 'block'; }
                else { cards = []; displayError("Konnte keine Lernkarten generieren oder die Antwort war leer."); }
            } catch (error) { console.error("Fehler beim Generieren der Lernkarten:", error); displayError(`Fehler: ${error.message}. Läuft der Backend-Server?`); cards = []; hideFlashcards();
            } finally { loadingIndicator.style.display = 'none'; generateButton.disabled = false; generateQuizButton.disabled = false; updateNavigation(); }
        });

        generateQuizButton.addEventListener('click', generateQuiz);
        flashcardContainer.addEventListener('click', flipCard);
        prevButton.addEventListener('click', () => { if (currentCardIndex > 0) { currentCardIndex--; displayCard(); } });
        nextButton.addEventListener('click', goToNextCard);
        knownButton.addEventListener('click', () => markCardStatus('known'));
        repeatButton.addEventListener('click', () => markCardStatus('repeat'));
        shuffleButton.addEventListener('click', shuffleCards);
        resetProgressButton.addEventListener('click', resetCurrentProgress);
        quizSubmitButton.addEventListener('click', handleQuizSubmit);

        // --- Initial State ---
        switchTab('text-input-area');
        hideFlashcards();
        hideQuiz();
        loadingIndicator.style.display = 'none';
        aiNotice.style.display = 'none';
        clearError();

      }); // End of DOMContentLoaded listener
    </script>

</body>
</html>
